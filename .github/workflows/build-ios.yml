# GitHub Actions workflow to build iOS IPA for Flutter project
# This workflow builds an IPA and uploads it as an artifact
# NOTE: iOS builds require code signing certificates and provisioning profiles

name: iOS IPA Build

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

env:
  FLUTTER_VERSION: '3.27.0'  # Uses Dart SDK 3.6.x, compatible with ^3.5.3

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Setup Flutter SDK
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          architecture: x64

      # Verify Flutter installation
      - name: Flutter Doctor
        run: flutter doctor -v

      # Get Flutter dependencies
      - name: Get dependencies
        run: flutter pub get

      # Create iOS folder if it doesn't exist
      - name: Create iOS project files
        run: |
          if [ ! -d "ios" ]; then
            flutter create --platforms=ios .
          fi

      # Set iOS deployment target to 14.0 (required by google_maps_flutter)
      - name: Set iOS Deployment Target
        run: |
          cd ios
          # Update Podfile to set minimum iOS version to 14.0
          sed -i '' "s/# platform :ios, '.*'/platform :ios, '14.0'/" Podfile
          sed -i '' "s/platform :ios, '.*'/platform :ios, '14.0'/" Podfile
          # Also update the Runner project settings
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]*/IPHONEOS_DEPLOYMENT_TARGET = 14.0/g' Runner.xcodeproj/project.pbxproj
          
          # Fix GoogleUtilities version conflict between Firebase and mobile_scanner
          # Add pod dependency override before 'target Runner'
          sed -i '' '/target .Runner. do/i\
          # Force GoogleUtilities version to resolve Firebase vs MLKit conflict\
          pod '\''GoogleUtilities'\'', '\''~> 8.0'\''\
          ' Podfile

      # Install CocoaPods dependencies
      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      # Build iOS app (unsigned - always runs for simplicity)
      - name: Build iOS (No Code Signing)
        run: flutter build ios --release --no-codesign

      # Create IPA from unsigned build
      - name: Create Unsigned IPA
        run: |
          mkdir -p build/ios/ipa
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../ipa/cardflow-unsigned.ipa Payload
          rm -rf Payload

      # Upload IPA artifact
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-release
          path: build/ios/ipa/*.ipa
          retention-days: 30
          if-no-files-found: warn

      # Upload dSYM for crash reporting
      - name: Upload dSYM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-dsym
          path: build/ios/iphoneos/Runner.app.dSYM
          retention-days: 30
          if-no-files-found: ignore
